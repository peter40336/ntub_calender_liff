<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8" />
    <title>LIFF測試</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="snackbar/snackbar.min.css"/>

    <script src="snackbar/snackbar.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.js"></script>
    
<script>
    function checkIsLogin (liff) {
        if (liff.isLoggedIn()) {
            liff.getProfile()
        } else {
            liff.login();
        }
    }

    function todoListPoint() {
        
        try {
            var userID = document.getElementById("uID").innerHTML
            var groupID = document.getElementById("gID").innerHTML
            var url = `https://line-calendar.sekixu.dev/event/list/${userID}?type_id=3`

            if (groupID != null && groupID != '') {
                url += `&group_id=${groupID}`
            }

            var todos_done = []
            var todos_notDone = []
            const res = fetchCurried(url)()
                    .then((v) => {
                        if (v.status != 200) {
                            errHandler(v.error_msg)
                            return
                        }

                        var result = v.data
                        
                        result.forEach(e => {
                            var _time = moment(e.start_time).local().format('YYYY-MM-DD');

                            if (e.is_done === true) {
                                todos_done.push({
                                    title: e.title,
                                    description: e.description,
                                    time: _time
                                })
                            } else {
                                todos_notDone.push({
                                    title: e.title,
                                    description: e.description,
                                    time: _time
                                })
                            }
                        });

                        console.log("todos_notDone", todos_notDone)
                        console.log("is_done", todos_done)
                    });;
            document.getElementById('load_screen').classList.add('d-none');
        } catch (error) {
            errHandler(error);
        }
    }

    function errHandler(err) {
        document.getElementById('load_screen').classList.add('d-none');
        
        Snackbar.show({
            actionTextColor: '#fff',
            backgroundColor: '#e7515a',
            text: err.errmsg ?? err.message,
            duration: 5000,
            pos: 'top-center',
            });
    }

    function successBar(msg) {
        Snackbar.show({
            actionTextColor: '#fff',
            backgroundColor: '#4361ee',
            text: msg,
            duration: 5000,
            pos: 'top-center',
        });
    }


    const fetchCurried = function (url) {
        return function (obj) {
            return new Promise((resolve, reject) => {
                $.post(url, obj || {}).done((data) => {
                    if (
                        Object.prototype.hasOwnProperty.call(data, 'error') ||
                        Object.prototype.hasOwnProperty.call(data, 'Error')
                    ) {
                        reject(data);
                    } else {
                        resolve(data);
                    }
                });
            });
        };
    };

    $(document).ready(function () {
        document.getElementById('load_screen').classList.remove('d-none');

        liff.init({
            liffId: '1657271223-kdg73xbw' // Use own liffId
        })
        .then(async () => checkIsLogin(liff))
        .then(() => {
            try {

                var context = liff.getContext();
                var getUrlString = location.href;
                var url = new URL(getUrlString);
                var groupID = url.searchParams.get('groupID')

                document.getElementById("gID").innerHTML = groupID;
                document.getElementById("uID").innerHTML = context.userId;
            } catch (e){
                errHandler(e);
            }
        })
        .then(() => {
            todoListPoint()
        })
        .catch((err) => {
            console.log(err.code, err.message);
        });
    });
</script>

<style>
    body {
        font-size: 20px;
    }

    .home-row {
        min-height: 90px;
        border-bottom: 1px solid #dee2e6;
    }

    .home-row-contain {
        min-height: 90px;
    }

    .remaining-row {
        min-height: 50px;
        border-bottom: 1px solid #dee2e6;
        justify-content: right;
        align-items: center;
    }
        div#load_screen {
            background: #ecefff;
            opacity: 1;
            position: fixed;
            z-index: 999999;
            top: 0px;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%; 
        }

        div#load_screen .loader {
            display: flex;
            justify-content: center;
            height: 100vh; 
        }

        div#load_screen .loader-content {
            right: 0;
            align-self: center; 
        }

        .spinner-grow {
        color: gray; 
        }

        div#load_screen .loader {
            width: 100vw;
        }

</style>


</head>
    <body>
        <div id="load_screen">
            <div class="loader">
                <div class="loader-content">
                    <div class="spinner-grow align-self-center"></div>
                </div>
            </div>
        </div>
        <span class="d-none" id="uID"></span>
        <span class="d-none" id="gID"></span>
        <header class="nav-tabs navbar py-3">
            <nav class="container-fluid justify-content-start">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor"
                    class="bi bi-chevron-left" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z" />
                </svg>
                <span class="fs-1 px-4">待辦事項</span>
            </nav>
        </header>

        <div class="row">
            <div class="remaining-row d-flex px-4">
                <span>尚未完成：4</span>
            </div>
        </div>

        <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <button class="nav-link active w-50" id="nav-done-tab" data-bs-toggle="tab" data-bs-target="#nav-done" type="button" role="tab" aria-controls="nav-done" aria-selected="true">已完成</button>
                <button class="nav-link w-50" id="nav-undone-tab" data-bs-toggle="tab" data-bs-target="#nav-undone" type="button" role="tab" aria-controls="nav-undone" aria-selected="false">未完成</button>
            </div>
        </nav>
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="nav-done" role="tabpanel" aria-labelledby="nav-done-tab">
                <div class="home-row">
                    <div class="home-row-contain d-flex align-items-center px-3 flex-wrap">
                        <div class="d-flex justify-content-between w-100">
                            <div>掃地</div>
                            <div>2022/10/10</div>
                        </div>
                        <div>
                            Me
                        </div>
			
                    </div>
                </div>
                <div class="home-row">
                    <div class="home-row-contain d-flex align-items-center px-3 flex-wrap">
                        <div class="d-flex justify-content-between w-100">
                            <div>訂餐廳</div>
                            <div>2022/10/14</div>
                        </div>
                        <div>
                            Me
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-undone" role="tabpanel" aria-labelledby="nav-undone-tab">
                <div class="home-row">
                    <div class="home-row-contain d-flex align-items-center px-3 flex-wrap">
                        <div class="d-flex justify-content-between w-100">
                            <div>採買</div>
                            <div>2022/10/01</div>
                        </div>
                        <div>
                            Me
                        </div>
			
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
    </body>
</html>

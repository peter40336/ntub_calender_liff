<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8" />
    <title>calender</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    
    <link rel="stylesheet" type="text/css" href="snackbar/snackbar.min.css"/>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>

    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
    <script src="snackbar/snackbar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
<script>

    function checkIsLogin (liff) {
        if (liff.isLoggedIn()) {
            liff.getProfile()
        } else {
            liff.login();
        }
    }

    function calendarPoint() {
        
        try {
            const o = {
                userID : document.getElementById("uID").innerHTML,
                roomID : document.getElementById("rID").innerHTML,
                groupID : document.getElementById("gID").innerHTML,
            }
            const res = fetchCurried('/rent/list')({
                pa: JSON.stringify(o),
            });

            console.log(o)
            // console.log(res)
            
            try {
                var calendarEl = document.getElementById('calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: { 
                        left: 'title',
                        center: 'prev,next today',
                        right: 'dayGridMonth,timeGridDay'
                    },
                    height: '600px',
                    locale: 'zh-tw',
                });
                // calendar.addEvent({
                //     title: 'Lunch1',
                //     start: '2022-10-08T12:30:00',
                //     end: '2022-10-08T13:30:00',
                // });
                // calendar.addEvent({
                //     title: 'Lunch2',
                //     start: '2022-10-08T13:30:00',
                //     end: '2022-10-08T14:30:00',
                // });
                // calendar.addEvent({
                //     title: 'Lunch3',
                //     start: '2022-10-08T14:30:00',
                //     end: '2022-10-08T15:30:00',
                // });
                // calendar.addEvent({
                //     title: 'Lunch4',
                //     start: '2022-10-08T15:30:00',
                //     end: '2022-10-08T16:30:00',
                // });
                // calendar.addEvent({
                //     title: 'Lunch4',
                //     start: '2022-10-08',
                // });
                calendar.render();
            } catch (e) {
                console.log(e)
            }
            
            document.getElementById('load_screen').classList.add('d-none');
        } catch (error) {
            errHandler(error);
        }
    }

    function errHandler(err) {
        document.getElementById('load_screen').classList.add('d-none');
        
        Snackbar.show({
            actionTextColor: '#fff',
            backgroundColor: '#e7515a',
            text: err.errmsg ?? err.message,
            duration: 5000,
            pos: 'top-center',
            });
    }

    function successBar(msg) {
        Snackbar.show({
            actionTextColor: '#fff',
            backgroundColor: '#4361ee',
            text: msg,
            duration: 5000,
            pos: 'top-center',
        });
    }


    const fetchCurried = function (url) {
        return function (obj) {
            return new Promise((resolve, reject) => {
                $.post(url, obj || {}).done((data) => {
                    if (
                        Object.prototype.hasOwnProperty.call(data, 'error') ||
                        Object.prototype.hasOwnProperty.call(data, 'Error')
                    ) {
                        reject(data);
                    } else {
                        resolve(data);
                    }
                });
            });
        };
    };

    $(document).ready(function () {
        document.getElementById('load_screen').classList.remove('d-none');

        liff.init({
            liffId: '1657271223-2bLxz75P' // Use own liffId
        })
        .then(async () => checkIsLogin(liff))
        .then(() => {
            try {
                var context = liff.getContext();
                var getUrlString = location.href;
                var url = new URL(getUrlString);
                url.searchParams.get('userId')
                var gID = url.searchParams.get('groupId')

                var rID = url.searchParams.get('roomId')

                document.getElementById("gID").innerHTML = gID;
                document.getElementById("rID").innerHTML = rID;
                document.getElementById("uID").innerHTML = context.userId;
                var msg = "gID: " + gID + "gID: " + rID + "uID: " + context.userId
                successBar(msg)

            } catch (e){
                errHandler(e);
            }
        })
        .then(() => {
            calendarPoint()
        })
        .catch((err) => {
            console.log(err.code, err.message);
        });
    });

</script>

<style>
    .container {
        height: 100%;
    }

    .fc .fc-toolbar-title {
        font-size: 1.25em !important;
    }

    html {
        color: #20232a !important;
        font-family: Muli,sans-serif;
        font-size: 16px;
        font-weight: 400;
        line-height: 1.7;
    }

    a {
        color: inherit;
        text-decoration: unset;
    }

    a:hover {
        color: inherit;
    }

    .fc .fc-toolbar.fc-header-toolbar {
        font-size: 0.9em
    }

    div#load_screen {
        background: #ecefff;
        opacity: 1;
        position: fixed;
        z-index: 999999;
        top: 0px;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%; 
    }

    div#load_screen .loader {
        display: flex;
        justify-content: center;
        height: 100vh; 
    }

    div#load_screen .loader-content {
        right: 0;
        align-self: center; 
    }

    .spinner-grow {
    color: gray; 
    }

    div#load_screen .loader {
        width: 100vw;
    }

</style>


    </head>
    <body>
        <div id="load_screen">
            <div class="loader">
                <div class="loader-content">
                    <div class="spinner-grow align-self-center"></div>
                </div>
            </div>
        </div>
        <span class="d-none" id="rID"></span>
        <span class="d-none" id="gID"></span>
        <span class="d-none" id="uID"></span>
        <header class="nav-tabs navbar py-3">
            <nav class="container-fluid justify-content-start">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor"
                    class="bi bi-chevron-left" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z" />
                </svg>
                <span class="fs-1 px-4">行事曆</span>
            </nav>
        </header>
        <div class="pt-4 container">
            <div id='calendar'></div>
        </div>
    </body>
</html>

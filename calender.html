<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8" />
    <title>calender</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    
    <link
      rel="stylesheet"
      type="text/css"
      href="snackbar/snackbar.min.css"
    />

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>


    <!-- Moment.js v2.20.0 -->
    <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.0/moment.min.js"></script> -->
    <!-- FullCalendar v3.8.1 -->
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.8.1/fullcalendar.min.css" rel="stylesheet"  /> -->
    <!-- <link href="" rel="stylesheet" media="print"></script> -->
    
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
    <script src="snackbar/snackbar.min.js"></script>
<script>

    // window.addEventListener("load", function(){
    //     var load_screen = document.getElementById("load_screen");
    //     document.body.removeChild(load_screen);
    // });
    // const loader = document.getElementById('load_screen');

    function checkIsLogin (liff) {
        if (liff.isLoggedIn()) {
            liff.getProfile()
        } else {
            liff.login();
        }
    }

    function calendarPoint() {
        
        try {
            const o = {
                userID : document.getElementById("uID").innerHTML,
                roomID : document.getElementById("rID").innerHTML,
                groupID : document.getElementById("gID").innerHTML,
            }
            const res = fetchCurried('/rent/list')({
                pa: JSON.stringify(o),
            });

            console.log(o)
            console.log(res)
            document.getElementById('load_screen').classList.add('d-none');
        } catch (error) {
            // errHandler(error);
        }
    }


    const fetchCurried = function (url) {
        return function (obj) {
            return new Promise((resolve, reject) => {
                $.post(url, obj || {}).done((data) => {
                    if (
                        Object.prototype.hasOwnProperty.call(data, 'error') ||
                        Object.prototype.hasOwnProperty.call(data, 'Error')
                    ) {
                        reject(data);
                    } else {
                        resolve(data);
                    }
                });
            });
        };
    };

    $(document).ready(function () {
        document.getElementById('load_screen').classList.remove('d-none');

        liff.init({
            liffId: '1657271223-2bLxz75P' // Use own liffId
        })
        .then(async () => checkIsLogin(liff))
        .then(() => {
            try {

                var data = {
                    accessToken: liff.getAccessToken()
                };
                console.log(data)
                
                // liff.getAccessToken().then((e) => {
                //     console.log("getAccessToken", e)
                // })

                const idToken = liff.getIDToken()
                console.log("getIDToken", idToken) 
                // liff.getIDToken().then((e) => {
                //     console.log("getIDToken", e)
                // })

                const idToken2 = liff.getDecodedIDToken();
                // liff.getDecodedIDToken().then((e) => {
                //     console.log("getDecodedIDToken", e)
                // })
                console.log(idToken2) // print decoded idToken object

                console.log("getContext", liff.getContext())

                var getUrlString = location.href;
                var url = new URL(getUrlString);
                url.searchParams.get('userId')
                var gID = url.searchParams.get('groupId')

                var rID = url.searchParams.get('roomId')

                document.getElementById("gID").innerHTML = gID;
                document.getElementById("rID").innerHTML = rID;
                document.getElementById("uID").innerHTML = profile.userId;
                successBar("gID: " + gID + "gID: " + rID + "uID: " + profile.userId)

            } catch (e){
                console.log(e)
            }
        })
        .then(() => {
            calendarPoint()
        })
        .catch((err) => {
            console.log(err.code, err.message);
        });
    });

    function successBar(msg) {
        Snackbar.show({
            actionTextColor: '#fff',
            backgroundColor: '#4361ee',
            text: msg,
            duration: 5000,
            pos: 'top-center',
        });
    }
</script>

<style>

    /* .home-row {
        min-height: 90px;
        border-bottom: 1px solid #dee2e6;
    }

    .home-row-contain {
        min-height: 90px;
    }

    
    div.row {
        --bs-gutter-x: unset;
    } */

    .container {
        height: 100%;
    }

    .fc .fc-toolbar-title {
        font-size: 1.25em !important;
    }

    html {
        color: #20232a !important;
        font-family: Muli,sans-serif;
        font-size: 16px;
        font-weight: 400;
        line-height: 1.7;
    }

    a {
        color: inherit;
        text-decoration: unset;
    }

    a:hover {
        color: inherit;
    }

    .fc .fc-toolbar.fc-header-toolbar {
        font-size: 0.9em
    }

    div#load_screen {
        background: #ecefff;
        opacity: 1;
        position: fixed;
        z-index: 999999;
        top: 0px;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%; 
    }

    div#load_screen .loader {
        display: flex;
        justify-content: center;
        height: 100vh; 
    }

    div#load_screen .loader-content {
        right: 0;
        align-self: center; 
    }

    .spinner-grow {
    color: gray; 
    }

    div#load_screen .loader {
        width: 100vw;
    }

</style>


    </head>
    <body>
        <header class="nav-tabs navbar py-3">
            <nav class="container-fluid justify-content-start">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor"
                    class="bi bi-chevron-left" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z" />
                </svg>
                <span class="fs-1 px-4">行事曆</span>
            </nav>
        </header>
        <div id="load_screen">
            <div class="loader">
                <div class="loader-content">
                    <div class="spinner-grow align-self-center"></div>
                </div>
            </div>
        </div>
        rID:<span id="rID"></span>
        gID:<span id="gID"></span>
        uID:<span id="uID"></span>
        <div class="pt-4 container">
            <div id='calendar'></div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var calendarEl = document.getElementById('calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: { 
                        left: 'title',
                        center: 'prev,next today',
                        right: 'dayGridMonth,timeGridDay'
                    },
                    height: '600px',
                    locale: 'zh-tw'
                });
                calendar.render();
            });
        </script>
    </body>
</html>
